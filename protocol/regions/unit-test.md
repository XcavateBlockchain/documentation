# Unit Test

use crate::{mock::\*, Error, Event};&#x20;

use crate::{&#x20;

HoldReason, LastRegionProposalBlock, LocationRegistration, OngoingRegionOwnerProposalVotes, OngoingRegionProposalVotes, RegionAuctions, RegionDetails, RegionOperatorAccounts, RegionOwnerProposals, RegionProposals, RegionReplacementAuctions, UserRegionOwnerVote, UserRegionVote, VoteStats,&#x20;

};&#x20;

use frame\_support::BoundedVec;&#x20;

use frame\_support::{&#x20;

assert\_noop, assert\_ok,&#x20;

traits::{fungible::Inspect, fungible::InspectHold, OnFinalize, OnInitialize},&#x20;

};&#x20;

use sp\_runtime::{traits::BadOrigin, Permill, TokenError};

macro\_rules! bvec { ($( $x:tt )_) => { vec!\[$( $x )_].try\_into().unwrap() } }

fn run\_to\_block(n: u64) { while System::block\_number() < n { if System::block\_number() > 0 { Regions::on\_finalize(System::block\_number()); System::on\_finalize(System::block\_number()); } System::reset\_events(); System::set\_block\_number(System::block\_number() + 1); System::on\_initialize(System::block\_number()); Regions::on\_initialize(System::block\_number()); } }

fn new\_region\_helper() { assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(31); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[8; 32].into()), 0, 100\_000 )); run\_to\_block(61); assert\_ok!(Regions::create\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), 0, 30, Permill::from\_percent(3) )); }

\#\[test] fn add\_regional\_operator\_works() { new\_test\_ext().execute\_with(|| { assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_eq!( RegionOperatorAccounts::::get::(\[8; 32].into()), Some(()) ); }) }

\#\[test] fn add\_regional\_operator\_fails() { new\_test\_ext().execute\_with(|| { assert\_noop!( Regions::add\_regional\_operator(RuntimeOrigin::signed(\[8; 32].into()), \[8; 32].into()), BadOrigin ); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_eq!( RegionOperatorAccounts::::get::(\[8; 32].into()), Some(()) ); assert\_noop!( Regions::add\_regional\_operator(RuntimeOrigin::root(), \[8; 32].into()), Error::::AlreadyRegionOperator ); }) }

\#\[test] fn remove\_regional\_operator\_works() { new\_test\_ext().execute\_with(|| { assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_eq!( RegionOperatorAccounts::::get::(\[8; 32].into()), Some(()) ); assert\_ok!(Regions::remove\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_eq!( RegionOperatorAccounts::::get::(\[8; 32].into()), None ); }) }

\#\[test] fn remove\_regional\_operator\_fails() { new\_test\_ext().execute\_with(|| { assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_eq!( RegionOperatorAccounts::::get::(\[8; 32].into()), Some(()) ); assert\_noop!( Regions::remove\_regional\_operator( RuntimeOrigin::signed(\[8; 32].into()), \[8; 32].into() ), BadOrigin ); assert\_noop!( Regions::remove\_regional\_operator(RuntimeOrigin::root(), \[7; 32].into()), Error::::NoRegionalOperator ); }) }

\#\[test] fn propose\_new\_region\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_eq!(RegionProposals::::get(0).unwrap().proposal\_expiry, 31); assert\_eq!( OngoingRegionProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 0, no\_voting\_power: 0 } ); }) }

\#\[test] fn propose\_new\_region\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_noop!( Regions::propose\_new\_region(RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10]), Error::::UserNotWhitelisted ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_eq!(LastRegionProposalBlock::::get(), None); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_eq!(LastRegionProposalBlock::::get(), Some(1)); run\_to\_block(10); assert\_noop!( Regions::propose\_new\_region(RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10]), Error::::RegionProposalCooldownActive ); }) }

\#\[test] fn vote\_on\_region\_proposal\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[2; 32].into() )); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[2; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( OngoingRegionProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 300\_000, no\_voting\_power: 0 } ); assert\_eq!( UserRegionVote::::get::\<u32, AccountId>(0, \[2; 32].into()).unwrap(), crate::Vote::Yes ); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[1; 32].into()), 0, crate::Vote::No )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[2; 32].into()), 0, crate::Vote::No )); assert\_eq!( OngoingRegionProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 200\_000, no\_voting\_power: 450\_000 } ); assert\_eq!( UserRegionVote::::get::\<u32, AccountId>(0, \[2; 32].into()).unwrap(), crate::Vote::No ); }) }

\#\[test] fn vote\_on\_region\_proposal\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[2; 32].into() )); assert\_noop!( Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[2; 32].into()), 0, crate::Vote::Yes ), Error::::NotOngoing ); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_noop!( Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[3; 32].into()), 0, crate::Vote::Yes ), Error::::UserNotWhitelisted ); run\_to\_block(40); assert\_noop!( Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[2; 32].into()), 0, crate::Vote::Yes ), Error::::ProposalExpired ); }) }

\#\[test] fn bid\_on\_region\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[2; 32].into() )); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(31); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 0, 1\_000 )); assert\_eq!(Balances::free\_balance(&(\[0; 32].into())), 199\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 1\_000 ); assert\_eq!(RegionAuctions::::get(0).unwrap().collateral, 1\_000); assert\_eq!( RegionAuctions::::get(0) .unwrap() .highest\_bidder .unwrap(), \[0; 32].into() ); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[1; 32].into()), 0, 25\_001 )); assert\_eq!(Balances::free\_balance(&(\[0; 32].into())), 200\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 0 ); assert\_eq!(Balances::free\_balance(&(\[1; 32].into())), 124\_999); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 25\_001 ); assert\_eq!(RegionAuctions::::get(0).unwrap().collateral, 25\_001); assert\_eq!( RegionAuctions::::get(0) .unwrap() .highest\_bidder .unwrap(), \[1; 32].into() ); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 0, 190\_000 )); assert\_eq!(RegionAuctions::::get(0).unwrap().collateral, 190\_000); assert\_eq!( RegionAuctions::::get(0) .unwrap() .highest\_bidder .unwrap(), \[0; 32].into() ); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 0, 195\_000 )); assert\_eq!(RegionAuctions::::get(0).unwrap().collateral, 195\_000); assert\_eq!( RegionAuctions::::get(0) .unwrap() .highest\_bidder .unwrap(), \[0; 32].into() ); assert\_eq!(Balances::free\_balance(&(\[0; 32].into())), 5\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 195\_000 ); assert\_eq!(Balances::free\_balance(&(\[1; 32].into())), 150\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 0 ); }) }

\#\[test] fn bid\_on\_region\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[0; 32].into()), 0, 1\_000), Error::::VotingStillOngoing, ); run\_to\_block(31); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[3; 32].into()), 0, 1\_000), Error::::UserNotRegionalOperator, ); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[1; 32].into()), 0, 0), Error::::BidCannotBeZero, ); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 0, 1\_000 )); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[1; 32].into()), 0, 500), Error::::BidTooLow, ); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[0; 32].into()), 0, 1\_000), Error::::BidTooLow, ); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[1; 32].into()), 0, 160\_000), TokenError::FundsUnavailable, ); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 1, crate::Vote::No )); run\_to\_block(61); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 1, 1\_000 )); System::assert\_last\_event(Event::RegionRejected { proposal\_id: 1 }.into()); assert\_noop!( Regions::bid\_on\_region(RuntimeOrigin::signed(\[1; 32].into()), 1, 1\_000), Error::::NoOngoingAuction, ); }) }

\#\[test] fn create\_new\_region\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(29); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[0; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[1; 32].into()), 1, crate::Vote::Yes )); run\_to\_block(31); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 0, 100\_000 )); run\_to\_block(59); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[0; 32].into()), 1, 70\_000 )); assert\_eq!(Balances::free\_balance(&(\[0; 32].into())), 30\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 170\_000 ); run\_to\_block(61); assert\_ok!(Regions::create\_new\_region( RuntimeOrigin::signed(\[1; 32].into()), 0, 30, Permill::from\_percent(3) )); assert\_eq!(RegionAuctions::::get(0).is\_none(), true); run\_to\_block(89); assert\_ok!(Regions::create\_new\_region( RuntimeOrigin::signed(\[1; 32].into()), 1, 30, Permill::from\_percent(3) )); assert\_eq!(Balances::free\_balance(&(\[0; 32].into())), 30\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 170\_000 ); assert\_eq!(RegionDetails::::get(0).unwrap().collection\_id, 0); assert\_eq!(RegionDetails::::get(1).unwrap().collection\_id, 1); assert\_eq!(RegionDetails::::get(0).unwrap().listing\_duration, 30); assert\_eq!(RegionDetails::::get(0).unwrap().owner, \[0; 32].into()); }) }

\#\[test] fn create\_new\_region\_does\_not\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_noop!( Regions::create\_new\_region( RuntimeOrigin::signed(\[7; 32].into()), 0, 30, Permill::from\_percent(3) ), Error::::UserNotRegionalOperator ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[7; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[7; 32].into() )); assert\_noop!( Regions::create\_new\_region( RuntimeOrigin::signed(\[7; 32].into()), 0, 30, Permill::from\_percent(3) ), Error::::NoAuction ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(31); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[8; 32].into()), 0, 100\_000 )); assert\_noop!( Regions::create\_new\_region( RuntimeOrigin::signed(\[7; 32].into()), 0, 30, Permill::from\_percent(3) ), Error::::AuctionNotFinished ); run\_to\_block(61); assert\_noop!( Regions::create\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), 0, 0, Permill::from\_percent(3) ), Error::::ListingDurationCantBeZero ); assert\_noop!( Regions::create\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), 0, 10\_001, Permill::from\_percent(3) ), Error::::ListingDurationTooHigh ); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 1, crate::Vote::Yes )); run\_to\_block(121); assert\_noop!( Regions::create\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), 1, 10\_000, Permill::from\_percent(3) ), Error::::NoAuction ); }) }

\#\[test] fn adjust\_listing\_duration\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_eq!(RegionDetails::::get(0).unwrap().listing\_duration, 30); assert\_ok!(Regions::create\_new\_location( RuntimeOrigin::signed(\[8; 32].into()), 0, bvec!\[10, 10] )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::adjust\_listing\_duration( RuntimeOrigin::signed(\[8; 32].into()), 0, 50, )); }) }

\#\[test] fn adjust\_listing\_duration\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_noop!( Regions::adjust\_listing\_duration(RuntimeOrigin::signed(\[8; 32].into()), 0, 50,), Error::::UserNotWhitelisted ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_noop!( Regions::adjust\_listing\_duration(RuntimeOrigin::signed(\[8; 32].into()), 0, 50,), Error::::RegionUnknown ); new\_region\_helper(); assert\_noop!( Regions::adjust\_listing\_duration(RuntimeOrigin::signed(\[0; 32].into()), 0, 50,), Error::::NoPermission ); assert\_noop!( Regions::adjust\_listing\_duration(RuntimeOrigin::signed(\[8; 32].into()), 0, 0,), Error::::ListingDurationCantBeZero ); assert\_noop!( Regions::adjust\_listing\_duration(RuntimeOrigin::signed(\[8; 32].into()), 0, 100000,), Error::::ListingDurationTooHigh ); }) }

// create\_new\_location function #\[test] fn create\_new\_location\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_ok!(Regions::propose\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), bvec!\[10, 10] )); assert\_ok!(Regions::vote\_on\_region\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 1, crate::Vote::Yes )); run\_to\_block(91); assert\_ok!(Regions::bid\_on\_region( RuntimeOrigin::signed(\[8; 32].into()), 1, 100\_000 )); run\_to\_block(121); assert\_ok!(Regions::create\_new\_region( RuntimeOrigin::signed(\[8; 32].into()), 1, 30, Permill::from\_percent(3) )); assert\_ok!(Regions::create\_new\_location( RuntimeOrigin::signed(\[8; 32].into()), 0, bvec!\[10, 10] )); assert\_ok!(Regions::create\_new\_location( RuntimeOrigin::signed(\[8; 32].into()), 0, bvec!\[9, 10] )); assert\_ok!(Regions::create\_new\_location( RuntimeOrigin::signed(\[8; 32].into()), 1, bvec!\[9, 10] )); assert\_eq!(Balances::free\_balance(&(\[8; 32].into())), 170\_000); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 200\_000 ); assert\_eq!( Balances::balance\_on\_hold( \&HoldReason::LocationDepositReserve.into(), &(\[8; 32].into()) ), 30\_000 ); assert\_eq!( LocationRegistration::::get::\<u32, BoundedVec\<u8, Postcode>>(0, bvec!\[10, 10]), true ); assert\_eq!( LocationRegistration::::get::\<u32, BoundedVec\<u8, Postcode>>(0, bvec!\[9, 10]), true ); assert\_eq!( LocationRegistration::::get::\<u32, BoundedVec\<u8, Postcode>>(1, bvec!\[9, 10]), true ); assert\_eq!( LocationRegistration::::get::\<u32, BoundedVec\<u8, Postcode>>(1, bvec!\[10, 10]), false ); assert\_eq!( LocationRegistration::::get::\<u32, BoundedVec\<u8, Postcode>>(1, bvec!\[8, 10]), false ); }) }

\#\[test] fn create\_new\_location\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_noop!( Regions::create\_new\_location(RuntimeOrigin::signed(\[8; 32].into()), 0, bvec!\[10, 10]), Error::::RegionUnknown ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_noop!( Regions::create\_new\_location(RuntimeOrigin::signed(\[7; 32].into()), 0, bvec!\[10, 10]), Error::::NoPermission ); }) }

\#\[test] fn propose\_remove\_regional\_operator\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_eq!(RegionOwnerProposals::::get(0).is\_some(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 0, no\_voting\_power: 0 } ); }) }

\#\[test] fn propose\_remove\_regional\_operator\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_noop!( Regions::propose\_remove\_regional\_operator(RuntimeOrigin::signed(\[0; 32].into()), 0), Error::::RegionUnknown, ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_noop!( Regions::propose\_remove\_regional\_operator(RuntimeOrigin::signed(\[1; 32].into()), 0), Error::::UserNotWhitelisted, ); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_eq!(RegionOwnerProposals::::get(0).is\_some(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 0, no\_voting\_power: 0 } ); assert\_noop!( Regions::propose\_remove\_regional\_operator(RuntimeOrigin::signed(\[0; 32].into()), 0), Error::::ProposalAlreadyOngoing, ); }) }

\#\[test] fn vote\_on\_remove\_owner\_proposal\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_eq!(RegionOwnerProposals::::get(0).is\_some(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 0, no\_voting\_power: 0 } ); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::No )); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 200\_000, no\_voting\_power: 400\_000 } ); assert\_eq!( UserRegionOwnerVote::::get::\<u32, AccountId>(0, \[0; 32].into()).unwrap(), crate::Vote::Yes ); }) }

\#\[test] fn vote\_on\_remove\_owner\_proposal\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_noop!( Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes ), Error::::NotOngoing, ); new\_region\_helper(); assert\_noop!( Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes ), Error::::NotOngoing, ); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_noop!( Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[1; 32].into()), 0, crate::Vote::Yes ), Error::::UserNotWhitelisted, ); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(91); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::DefensePeriod ); assert\_noop!( Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes ), Error::::NotOngoing, ); }) }

\#\[test] fn remove\_owner\_proposal\_passes() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::MistrustVoting ); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 600\_000, no\_voting\_power: 0 } ); run\_to\_block(91); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::DefensePeriod ); run\_to\_block(121); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::SlashVoting ); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 100\_000 ); assert\_eq!(Balances::total\_balance(&(\[8; 32].into())), 400\_000); assert\_eq!(Balances::total\_issuance(), 1\_055\_000); run\_to\_block(151); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::ReplacementVoting ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 90\_000 ); assert\_eq!(Balances::total\_balance(&(\[8; 32].into())), 390\_000); assert\_eq!(Balances::total\_issuance(), 1\_045\_000); System::assert\_last\_event( Event::RegionalOperatorSlashed { region\_id: 0, operator: \[8; 32].into(), amount: 10\_000, } .into(), ); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); run\_to\_block(181); assert\_eq!(RegionOwnerProposals::::get(0).is\_none(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).is\_none(), true ); assert\_eq!( UserRegionOwnerVote::::get::\<u32, AccountId>(0, \[0; 32].into()).is\_none(), true ); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 181 ); System::assert\_last\_event( Event::RegionOwnerChangeEnabled { region\_id: 0, next\_change\_allowed: 181, } .into(), ); }) }

\#\[test] fn remove\_owner\_proposal\_doesnt\_pass() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); run\_to\_block(91); assert\_eq!(RegionOwnerProposals::::get(0).is\_none(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).is\_none(), true ); assert\_eq!( UserRegionOwnerVote::::get::\<u32, AccountId>(0, \[0; 32].into()).is\_none(), true ); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 600\_000, no\_voting\_power: 0 } ); run\_to\_block(121); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::DefensePeriod ); run\_to\_block(151); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::SlashVoting ); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::No )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 400\_000, no\_voting\_power: 200\_000 } ); run\_to\_block(181); assert\_eq!(RegionOwnerProposals::::get(0).is\_none(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).is\_none(), true ); assert\_eq!( UserRegionOwnerVote::::get::\<u32, AccountId>(0, \[0; 32].into()).is\_none(), true ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 100\_000 ); assert\_eq!(Balances::total\_balance(&(\[8; 32].into())), 400\_000); assert\_eq!(Balances::total\_issuance(), 1\_055\_000); assert\_eq!(RegionOwnerProposals::::get(0).is\_none(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).is\_none(), true ); assert\_eq!( UserRegionOwnerVote::::get::\<u32, AccountId>(0, \[0; 32].into()).is\_none(), true ); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(241); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(271); assert\_eq!( RegionOwnerProposals::::get(0).unwrap().state, crate::ProposalState::ReplacementVoting ); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::No )); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).unwrap(), VoteStats { yes\_voting\_power: 200\_000, no\_voting\_power: 390\_000 } ); run\_to\_block(301); assert\_eq!(RegionOwnerProposals::::get(0).is\_none(), true); assert\_eq!( OngoingRegionOwnerProposalVotes::::get(0).is\_none(), true ); assert\_eq!( UserRegionOwnerVote::::get::\<u32, AccountId>(0, \[0; 32].into()).is\_none(), true ); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); }) }

\#\[test] fn bid\_on\_region\_replacement\_after\_proposal\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::propose\_remove\_regional\_operator( RuntimeOrigin::signed(\[0; 32].into()), 0 )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[8; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(121); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); run\_to\_block(151); assert\_ok!(Regions::vote\_on\_remove\_owner\_proposal( RuntimeOrigin::signed(\[0; 32].into()), 0, crate::Vote::Yes )); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); run\_to\_block(182); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 181 ); assert\_eq!(RegionReplacementAuctions::::get(0).is\_none(), true); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[0; 32].into()), 0, 10\_000 )); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 90\_000 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 10\_000 ); assert\_eq!( RegionReplacementAuctions::::get(0).unwrap(), crate::RegionAuction { highest\_bidder: Some(\[0; 32].into()), collateral: 10\_000, auction\_expiry: 212, } ); run\_to\_block(200); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[1; 32].into()), 0, 35\_000 )); assert\_eq!( RegionReplacementAuctions::::get(0).unwrap(), crate::RegionAuction { highest\_bidder: Some(\[1; 32].into()), collateral: 35\_000, auction\_expiry: 212, } ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 0 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 35\_000 ); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[8; 32].into()), 0, 40\_000 )); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 0 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 130\_000 ); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[0; 32].into()), 0, 51\_000 )); run\_to\_block(213); assert\_eq!(RegionDetails::::get(0).unwrap().owner, \[0; 32].into()); assert\_eq!(RegionDetails::::get(0).unwrap().collateral, 51\_000); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 512 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 0 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 51\_000 ); assert\_eq!(RegionReplacementAuctions::::get(0).is\_none(), true); }) }

\#\[test] fn bid\_on\_region\_replacement\_after\_time\_works() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); new\_region\_helper(); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); run\_to\_block(362); assert\_eq!(RegionReplacementAuctions::::get(0).is\_none(), true); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[1; 32].into() )); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[1; 32].into()), 0, 80\_000 )); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 100\_000 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 80\_000 ); assert\_eq!( RegionReplacementAuctions::::get(0).unwrap(), crate::RegionAuction { highest\_bidder: Some(\[1; 32].into()), collateral: 80\_000, auction\_expiry: 392, } ); run\_to\_block(370); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[1; 32].into()), 0, 85\_000 )); assert\_eq!( RegionReplacementAuctions::::get(0).unwrap(), crate::RegionAuction { highest\_bidder: Some(\[1; 32].into()), collateral: 85\_000, auction\_expiry: 392, } ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 85\_000 ); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[8; 32].into()), 0, 90\_000 )); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[1; 32].into())), 0 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 190\_000 ); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[0; 32].into()), 0, 92\_000 )); run\_to\_block(394); assert\_eq!(RegionDetails::::get(0).unwrap().owner, \[0; 32].into()); assert\_eq!(RegionDetails::::get(0).unwrap().collateral, 92\_000); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 692 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[8; 32].into())), 0 ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 92\_000 ); assert\_eq!(RegionReplacementAuctions::::get(0).is\_none(), true); }) }

\#\[test] fn bid\_on\_region\_replacement\_after\_time\_fails() { new\_test\_ext().execute\_with(|| { System::set\_block\_number(1); assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[1; 32].into() )); assert\_noop!( Regions::bid\_on\_region\_replacement(RuntimeOrigin::signed(\[1; 32].into()), 0, 10\_000), Error::::RegionUnknown ); new\_region\_helper(); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); run\_to\_block(200); assert\_noop!( Regions::bid\_on\_region\_replacement(RuntimeOrigin::signed(\[1; 32].into()), 0, 10\_000), Error::::RegionOwnerCantBeChanged ); run\_to\_block(362); assert\_noop!( Regions::bid\_on\_region\_replacement(RuntimeOrigin::signed(\[2; 32].into()), 0, 10\_000), Error::::UserNotRegionalOperator ); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[0; 32].into()), 0, 80\_000 )); assert\_noop!( Regions::bid\_on\_region\_replacement(RuntimeOrigin::signed(\[1; 32].into()), 0, 10\_000), Error::::BidTooLow ); assert\_noop!( Regions::bid\_on\_region\_replacement(RuntimeOrigin::signed(\[1; 32].into()), 0, 200\_000), TokenError::FundsUnavailable, ); assert\_noop!( Regions::bid\_on\_region\_replacement(RuntimeOrigin::signed(\[0; 32].into()), 0, 300\_000), TokenError::FundsUnavailable, ); assert\_eq!( Balances::balance\_on\_hold(\&HoldReason::RegionDepositReserve.into(), &(\[0; 32].into())), 80\_000 ); }) }

\#\[test] fn initiate\_region\_owner\_resignation\_works() { new\_test\_ext().execute\_with(|| { assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[0; 32].into() )); new\_region\_helper(); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); run\_to\_block(100); assert\_ok!(Regions::initiate\_region\_owner\_resignation( RuntimeOrigin::signed(\[8; 32].into()), 0 )); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 200 ); System::assert\_last\_event( Event::RegionOwnerResignationInitiated { region\_id: 0, region\_owner: \[8; 32].into(), next\_owner\_change: 200, } .into(), ); run\_to\_block(201); assert\_ok!(Regions::bid\_on\_region\_replacement( RuntimeOrigin::signed(\[0; 32].into()), 0, 80\_000 )); }) }

\#\[test] fn initiate\_region\_owner\_resignation\_fails() { new\_test\_ext().execute\_with(|| { assert\_ok!(XcavateWhitelist::add\_to\_whitelist( RuntimeOrigin::root(), \[8; 32].into() )); assert\_ok!(Regions::add\_regional\_operator( RuntimeOrigin::root(), \[8; 32].into() )); assert\_noop!( Regions::initiate\_region\_owner\_resignation(RuntimeOrigin::signed(\[8; 32].into()), 0), Error::::RegionUnknown ); new\_region\_helper(); assert\_noop!( Regions::initiate\_region\_owner\_resignation(RuntimeOrigin::signed(\[0; 32].into()), 0), Error::::NotRegionOwner ); assert\_eq!( RegionDetails::::get(0).unwrap().next\_owner\_change, 361 ); run\_to\_block(300); assert\_noop!( Regions::initiate\_region\_owner\_resignation(RuntimeOrigin::signed(\[8; 32].into()), 0), Error::::OwnerChangeTooEarly ); run\_to\_block(400); assert\_noop!( Regions::initiate\_region\_owner\_resignation(RuntimeOrigin::signed(\[8; 32].into()), 0), Error::::OwnerChangeTooEarly ); }) }
